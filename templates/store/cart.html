{% extends 'base.html' %}
{% load static %}

{% block content %}

{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<section class="section-content padding-y bg">
<div class="container">

{% if not cart_items %}
	<h2 class="text-center">Your Shopping Cart is Empty</h2>
	<br>
	<div class="text-center">
		<a href="{% url 'store' %}" class="btn btn-primary">Continue Shopping</a>
	</div>
{% else %}

<div class="row">
	<aside class="col-lg-9">

<div class="card">
<table class="table table-borderless table-shopping-cart">
<thead class="text-muted">
<tr class="small text-uppercase">
  <th scope="col">Product</th>
  <th scope="col" width="120">Quantity</th>
  <th scope="col" width="120">Price</th>
  <th scope="col" class="text-right" width="200"></th>
</tr>
</thead>
<tbody>

{% for cart_item in cart_items %}
<tr>
	<td>
		<figure class="itemside align-items-center">
			<div class="aside">
                <img src="{{ cart_item.product.images.url }}" class="img-sm">
            </div>

			<figcaption class="info">
				<a href="{{ cart_item.product.get_url }}" class="title text-dark">
                    {{ cart_item.product.product_name }}
                </a>

				<!-- HIỂN THỊ BIẾN THỂ MỚI -->
				<p class="text-muted small" style="margin: 0;">
					Color: {{ cart_item.variant.color|capfirst }}
				</p>
				<p class="text-muted small" style="margin: 0;">
					Size: {{ cart_item.variant.size|upper }}
				</p>
			</figcaption>
		</figure>
	</td>

	<td>
       <div class="input-group input-spinner" style="width: 140px; flex-wrap: nowrap;"> <div class="input-group-prepend">
                <a href="{% url 'remove_cart' cart_item.product.id cart_item.id %}"
                       class="btn btn-light"
                       style="border-color: #e4e4e4;"> <i class="fa fa-minus"></i>
                </a>
             </div>

             <input type="text" class="form-control text-center" value="{{ cart_item.quantity }}" style="border-color: #e4e4e4;">

             <div class="input-group-append">
                <form action="{% url 'add_cart' cart_item.product.id %}" method="POST" style="display: flex; margin: 0;">
                   {% csrf_token %}
                   <input type="hidden" name="color" value="{{ cart_item.variant.color }}">
                   <input type="hidden" name="size" value="{{ cart_item.variant.size }}">

                   <button class="btn btn-light" type="submit" id="button-plus" style="border-color: #e4e4e4;">
                        <i class="fa fa-plus"></i>
                   </button>
                </form>
             </div>

       </div>
    </td>

	<td>
		<div class="price-wrap">
			<var class="price">$ {{ cart_item.sub_total }}</var>
			<small class="text-muted"> $ {{ cart_item.product.price }} each </small>
		</div>
	</td>

	<td class="text-right">
		<a href="{% url 'remove_cart_item' cart_item.product.id cart_item.id %}"
           onclick="return confirm('Are you sure you want to delete this item?')"
           class="btn btn-danger">
            Remove
        </a>
	</td>
</tr>
{% endfor %}

</tbody>
</table>
</div>

<form action="{% url 'coupons:apply_coupon' %}" method="post" class="d-flex gap-2 mt-3" style="max-width:420px;">
    {% csrf_token %}
    {{ coupon_form.code }}
    <button type="submit" class="btn btn-outline-primary">Apply</button>
</form>

{% if discount_percent %}
<p class="mt-2">
    Đang áp dụng mã giảm: <strong>{{ discount_percent }}%</strong>
    (<a href="{% url 'remove_coupon' %}">Bỏ mã</a>)
</p>
{% endif %}

</aside>

<aside class="col-lg-3">
	<div class="card">
		<div class="card-body">

         <dl class="dlist-align">
           <dt>Total price:</dt>
           <dd class="text-right">$ {{total}}</dd>
         </dl>

         {% if discount_percent %}
         <dl class="dlist-align">
            <dt>Discount:</dt>
            <dd class="text-right text-danger">− $ {{ discount_amount }}</dd>
         </dl>
         {% endif %}

		 <dl class="dlist-align">
			  <dt>VAT:</dt>
			  <dd class="text-right">$ {{VAT}}</dd>
		 </dl>

		 <dl class="dlist-align">
			  <dt>Grand Total:</dt>
			  <dd class="text-right text-dark b"><strong>$ {{grand_total}}</strong></dd>
		 </dl>

		 <hr>
		 <p class="text-center mb-3">
			<img src="{% static './images/misc/payments.png' %}" height="26">
		 </p>

		 <a href="{% url 'checkout' %}" class="btn btn-primary btn-block"> Checkout </a>
		 <a href="{% url 'store' %}" class="btn btn-light btn-block">Continue Shopping</a>
	  </div>
	</div>
</aside>

</div>

{% endif %}

</div>
</section>

{% endblock %}
