{% extends 'base.html' %}
{% load static %}


{% block content %}


<!-- Breadcrumb / Back Button -->
<div class="container" style="margin-top: 30px;">
   <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
       <i class="fa fa-arrow-left"></i> Back to Dashboard
   </a>
</div>


<!-- Order Detail -->
<div class="container" style="max-width: 900px; margin: 30px auto; background: #f8f9fa; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
   <div class="invoice">
       <!-- Header -->
       <div class="row mb-4">
           <div class="col-md-6">
               <img src="{% static 'images/logo.png' %}" alt="Logo" style="max-height: 50px;">
           </div>
           <div class="col-md-6 text-right">
               <h4 class="text-muted mb-2">ORDER DETAILS</h4>
               <span class="badge badge-{% if order.status == 'New' %}info{% elif order.status == 'Accepted' %}primary{% elif order.status == 'Completed' %}success{% else %}danger{% endif %}" style="font-size: 14px; padding: 8px 15px;">
                   {{ order.status }}
               </span>
           </div>
       </div>


       <hr>


       <!-- Order Info & Customer Info -->
       <div class="row mb-4">
           <div class="col-md-6">
               <h6 class="text-uppercase text-muted mb-3">
                   <i class="fa fa-file-alt"></i> Order Information
               </h6>
               <table class="table table-sm table-borderless">
                   <tr>
                       <td class="text-muted" style="width: 150px;">Order #</td>
                       <td><strong>{{ order.order_number }}</strong></td>
                   </tr>
                   <tr>
                       <td class="text-muted">Transaction ID</td>
                       <td>
                           {% if order.payment %}
                               <strong>{{ order.payment.payment_id }}</strong>
                           {% else %}
                               <span class="text-muted">Not paid yet</span>
                           {% endif %}
                       </td>
                   </tr>
                   <tr>
                       <td class="text-muted">Order Date</td>
                       <td>{{ order.created_at|date:"M d, Y, g:i a" }}</td>
                   </tr>
                   <tr>
                       <td class="text-muted">Payment Method</td>
                       <td>
                           {% if order.payment %}
                               {{ order.payment.payment_method }}
                           {% else %}
                               <span class="text-muted">N/A</span>
                           {% endif %}
                       </td>
                   </tr>
                   <tr>
                       <td class="text-muted">Order Status</td>
                       <td>
                           <span class="badge badge-success">{{ order.status }}</span>
                       </td>
                   </tr>
                   <tr>
                       <td class="text-muted">IP Address</td>
                       <td>{{ order.ip }}</td>
                   </tr>
               </table>
           </div>
           <div class="col-md-6">
               <h6 class="text-uppercase text-muted mb-3">
                   <i class="fa fa-user"></i> Customer Information
               </h6>
               <table class="table table-sm table-borderless">
                   <tr>
                       <td class="text-muted" style="width: 100px;">Name</td>
                       <td><strong>{{ order.full_name }}</strong></td>
                   </tr>
                   <tr>
                       <td class="text-muted">Email</td>
                       <td><a href="mailto:{{ order.email }}">{{ order.email }}</a></td>
                   </tr>
                   <tr>
                       <td class="text-muted">Phone</td>
                       <td><a href="tel:{{ order.phone }}">{{ order.phone }}</a></td>
                   </tr>
                   <tr>
                       <td class="text-muted">Address</td>
                       <td>
                           {{ order.address_line_1 }}
                           {% if order.address_line_2 %}
                               , {{ order.address_line_2 }}
                           {% endif %}
                           <br>
                           {{ order.city }}{% if order.state %}, {{ order.state }}{% endif %}<br>
                           {{ order.country }}
                       </td>
                   </tr>
                   {% if order.order_note %}
                   <tr>
                       <td class="text-muted">Note</td>
                       <td><em>"{{ order.order_note }}"</em></td>
                   </tr>
                   {% endif %}
               </table>
           </div>
       </div>


       <hr>


       <!-- Products Table -->
       <h6 class="text-uppercase text-muted mb-3">
           <i class="fa fa-shopping-cart"></i> Products
       </h6>
       <div class="table-responsive">
           <table class="table table-hover">
               <thead class="bg-light">
                   <tr>
                       <th style="width: 50%;">Product</th>
                       <th class="text-center" style="width: 15%;">Quantity</th>
                       <th class="text-right" style="width: 15%;">Price</th>
                       <th class="text-right" style="width: 20%;">Total</th>
                   </tr>
               </thead>
               <tbody>
                   {% for item in order_items %}
                   <tr>
                       <td>
                           <div class="d-flex align-items-center">
                               <img src="{{ item.product.images.url }}" alt="{{ item.product.product_name }}"
                                    style="width: 60px; height: 60px; object-fit: cover; margin-right: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                               <div>
                                   <strong>{{ item.product.product_name }}</strong>
                                   {% if item.variations.all %}
                                       <br>
                                       <small class="text-muted">
                                           {% for var in item.variations.all %}
                                               <span class="badge badge-secondary" style="margin-right: 5px;">
                                                   {{ var.variation_category|capfirst }}: {{ var.variation_value|capfirst }}
                                               </span>
                                           {% endfor %}
                                       </small>
                                   {% endif %}
                               </div>
                           </div>
                       </td>
                       <td class="text-center" style="vertical-align: middle;">
                           <strong>{{ item.quantity }}</strong>
                       </td>
                       <td class="text-right" style="vertical-align: middle;">
                           ${{ item.product_price|floatformat:1 }}
                       </td>
                       <td class="text-right" style="vertical-align: middle;">
                           <strong>${{ item.product_price|floatformat:0 }}</strong>
                       </td>
                   </tr>
                   {% empty %}
                   <tr>
                       <td colspan="4" class="text-center text-muted">No products found</td>
                   </tr>
                   {% endfor %}
               </tbody>
           </table>
       </div>


       <hr>


       <!-- Total Summary -->
       <div class="row">
           <div class="col-md-6 offset-md-6">
               <table class="table table-sm">
                   <tr>
                       <td class="text-right"><strong>Sub Total:</strong></td>
                       <td class="text-right" style="width: 150px;">${{ subtotal|floatformat:1 }} USD</td>
                   </tr>
                   {% if order.discount > 0 %}
                   <tr style="color: #28a745;">
                       <td class="text-right"><strong>Discount{% if order.coupon %} ({{ order.coupon }}){% endif %}:</strong></td>
                       <td class="text-right">-${{ order.discount|floatformat:1 }} USD</td>
                   </tr>
                   {% endif %}
                   <tr>
                       <td class="text-right"><strong>Tax (VAT 8%):</strong></td>
                       <td class="text-right">${{ order.VAT|floatformat:1 }} USD</td>
                   </tr>
                   <tr style="background-color: #f8f9fa; font-size: 1.1em;">
                       <td class="text-right"><strong>Grand Total:</strong></td>
                       <td class="text-right"><strong style="color: #007bff;">${{ order.order_total|floatformat:1 }} USD</strong></td>
                   </tr>
               </table>
           </div>
       </div>


       <hr>


       <!-- Admin Actions - Chỉ hiển thị cho admin/staff -->
       {% if user.role == 'admin' or user.role == 'staff' %}
       <div class="mt-4 mb-4">
           <h6 class="text-uppercase text-muted mb-3">
               <i class="fa fa-cog"></i> Admin Actions
           </h6>
           <form method="POST" class="form-inline">
               {% csrf_token %}
               <div class="form-group mr-3">
                   <label for="status" class="mr-2"><strong>Update Order Status:</strong></label>
                   <select name="status" id="status" class="form-control" style="min-width: 200px;">
                       <option value="Preparing Order" {% if order.status == 'Preparing Order'%}selected{% endif %}>Preparing Order</option>
                       <option value="Shipping" {% if order.status == 'Shipping' %}selected{% endif %}>Shipping</option>
                       <option value="Completed" {% if order.status == 'Completed' %}selected{% endif %}>Completed</option>
                       <option value="Returned To Warehouse" {% if order.status == 'Returned To Warehouse'%}selected{% endif %}>Returned To Warehouse</option>
                       <option value="Cancelled" {% if order.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                   </select>
               </div>
               <button type="submit" class="btn btn-primary">
                   <i class="fa fa-save"></i> Update Status
               </button>
           </form>
       </div>
       <hr>
       {% endif %}


       <!-- Action Buttons -->
       <div class="text-center mt-4">
           <!-- Request Return Button - Only for Customer with Completed Orders within 14 days -->
           {% if user.role == 'customer' and can_return %}
               <a href="{% url 'create_return' order.order_number %}"
                  class="btn btn-danger mr-2">
                   <i class="fa fa-undo"></i> Request Return
               </a>
               <small class="text-muted d-block mb-3">
                   <i class="fa fa-clock"></i> You can return this order within {{ 14|add:"-"|add:days_since_order }} days ({{ days_since_order }} days ago)
               </small>
           {% endif %}

           <button onclick="window.print()" class="btn btn-secondary">
               <i class="fa fa-print"></i> Print Invoice
           </button>
           {% if user.role == 'admin' or user.role == 'staff' %}
           <a href="mailto:{{ order.email }}?subject=Regarding Order {{ order.order_number }}" class="btn btn-info">
               <i class="fa fa-envelope"></i> Email Customer
           </a>
           {% endif %}
       </div>


       <!-- Footer Note -->
       <div class="text-center mt-4 pt-3" style="border-top: 1px solid #dee2e6;">
           <p class="text-muted mb-1"><small>Last updated: {{ order.updated_at|date:"M d, Y, g:i a" }}</small></p>
           <p class="text-muted mb-0"><small>Thank you for shopping with us!</small></p>
       </div>
   </div>
</div>


<!-- Custom CSS -->
<style>
   .invoice {
       background: white;
       padding: 30px;
       border-radius: 8px;
   }
   .table-hover tbody tr:hover {
       background-color: #f8f9fa;
   }
   @media print {
       .btn, form, nav, footer, .container > a {
           display: none !important;
       }
       body {
           background: white !important;
       }
       .container {
           max-width: 100% !important;
           margin: 0 !important;
           padding: 20px !important;
       }
   }
</style>


{% endblock %}

